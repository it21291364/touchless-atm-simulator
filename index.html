<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Touchless ATM Simulator – Realistic UX</title>
<style>
  :root { --bg:#0a0f1f; --p1:#1c2638; --p2:#121826; --ink:#e5e7eb; --muted:#9fb0c6; --accent:#3f8cff; --ok:#22c55e; --warn:#f59e0b; }
  *{box-sizing:border-box}
  body { margin: 0; font-family: system-ui, Segoe UI, Roboto, Inter, sans-serif; background: radial-gradient(900px 700px at 50% -20%, #14203a 0%, #0a0f1f 60%); color: var(--ink); height: 100vh; display: grid; place-items: center; }
  #app { position: relative; width: 100vw; height: 100vh; display: grid; place-items: center; }
  video { display:none; }
  /* Pointer canvas is on top of everything */
  #overlay { position: fixed; inset: 0; pointer-events: none; z-index: 10000; }

  .atm { width: 380px; background: linear-gradient(145deg, var(--p1), var(--p2)); border: 2px solid #2a3850; border-radius: 20px; padding: 18px; box-shadow: 0 18px 48px rgba(0,0,0,.55); position: relative; }
  .slot { height: 12px; background: #0b1224; border: 1px solid #233252; border-radius: 8px; margin-bottom: 10px; box-shadow: inset 0 2px 6px rgba(0,0,0,.6); }
  .screen { background:#000; color:#0f0; border-radius:10px; padding:14px; min-height:90px; margin-bottom:14px; font: 700 16px/1.35 "Courier New", ui-monospace, monospace; text-align:center; box-shadow: inset 0 0 10px #00ff00aa; }
  .typing { white-space: pre-line; }
  .buttons { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  .btn { background: linear-gradient(180deg,#2e3b4e,#1a2433); border: 1px solid #3d526b; border-radius: 10px; padding: 14px; text-align:center; font-size: 18px; cursor:pointer; user-select:none; box-shadow: 0 6px 14px rgba(0,0,0,.4); transition: transform .1s, filter .15s; }
  .btn.hover, .btn:active { transform: scale(1.05); filter: brightness(1.15); }
  .menu-btns { display:flex; flex-direction:column; gap:10px; }
  .menu-btns .btn { font-size: 16px; padding: 12px; }
  .soft { color: var(--muted); font-size: 12px; margin-top: 6px; }
  .row { display:flex; justify-content: center; gap:10px; margin-top:8px; }
  .receipt { display:none; margin-top:12px; background:#0b1224; border:1px dashed #2b3a58; padding:10px; border-radius:8px; font: 14px/1.3 ui-monospace, monospace; color:#cfe6ff; text-align:left; }
  .note { font-size:12px; color:#a0f0a0; }
</style>
</head>
<body>
<div id="app">
  <video id="video" playsinline></video>
  <canvas id="overlay"></canvas>
  <div class="atm">
    <div class="slot"></div>
    <div id="screen" class="screen"><span class="typing" id="typing"></span><div class="soft" id="sub"></div></div>
    <div id="keypad" class="buttons"></div>
    <div id="menu" class="menu-btns" style="display:none"></div>
    <div id="yn" class="row" style="display:none">
      <div class="btn" data-yn="yes">YES</div>
      <div class="btn" data-yn="no">NO</div>
    </div>
    <div id="receipt" class="receipt"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script>
  // Elements
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const typing = document.getElementById('typing');
  const sub = document.getElementById('sub');
  const keypad = document.getElementById('keypad');
  const menu = document.getElementById('menu');
  const yn = document.getElementById('yn');
  const receipt = document.getElementById('receipt');

  // State
  let state = 'WELCOME';
  let pin = '';
  let balance = 50000; // start balance
  let customAmount = '';
  let attempts = 0;

  // Dwell selection
  const DWELL_MS = 750;
  let dwellStart = null;
  let hoveredBtn = null;

  // Smoothing for pointer
  let sx = null, sy = null; const SMOOTH = 0.35; // higher = snappier

  // Helpers
  const fmt = n => 'LKR ' + Number(n).toLocaleString('en-LK');

  // UI building
  function setKeypad(labels){
    keypad.innerHTML = '';
    labels.forEach(l => { const b = document.createElement('div'); b.className='btn'; b.textContent=l; keypad.appendChild(b); });
  }
  function setMenu(items){
    menu.style.display = 'flex'; menu.innerHTML = '';
    items.forEach(l=>{ const b=document.createElement('div'); b.className='btn'; b.textContent=l; b.setAttribute('data-target',''); menu.appendChild(b); });
  }
  function setYN(show){ yn.style.display = show ? 'flex' : 'none'; }

  // Fancy output
  async function typeMessage(lines, speed=18){
    typing.textContent = ''; sub.textContent='';
const text = Array.isArray(lines) ? lines.join('\n') : String(lines);
    for(let i=0;i<text.length;i++){
      typing.textContent += text[i];
      await new Promise(r=>setTimeout(r, speed));
    }
  }
  function setSub(text){ sub.textContent = text || ''; }

  // Sound (simple beep)
  function beep(freq=880, dur=60){
    try{
      const a = new (window.AudioContext||window.webkitAudioContext)();
      const o = a.createOscillator(); const g = a.createGain();
      o.connect(g); g.connect(a.destination); o.type='square'; o.frequency.value=freq; g.gain.value=0.02;
      o.start(); setTimeout(()=>{o.stop(); a.close();}, dur);
    }catch(_){/* ignore */}
  }

  // Screens
  async function showWelcome(){
    state='WELCOME'; keypad.innerHTML=''; menu.style.display='none'; setYN(false); receipt.style.display='none';
    await typeMessage(['Welcome to Touchless Bank','Please insert your card']);
    setSub('Hover over START to begin');
    setKeypad(['Start']);
  }

  async function readingCard(){
    state='READING_CARD'; keypad.innerHTML=''; menu.style.display='none'; setYN(false);
    let dots = 0; const id = setInterval(()=>{ dots=(dots+1)%4; setSub('Reading card' + '.'.repeat(dots)); }, 350);
    await typeMessage(['Card detected','Please wait...']);
    setTimeout(()=>{ clearInterval(id); askPIN(); }, 1200);
  }

  async function askPIN(){
    state='PIN'; setYN(false); menu.style.display='none';
    await typeMessage(['Please enter your PIN']);
    setSub('Use keypad. ⌫ to delete, OK to continue');
    setKeypad(['1','2','3','4','5','6','7','8','9','0','⌫','OK']);
  }

  async function pinResult(ok){
    if(ok){ attempts=0; await typeMessage(['PIN accepted']); setSub('Loading menu...'); setTimeout(showMenu, 700); }
    else {
      attempts++; await typeMessage(['Incorrect PIN. Please try again']); setSub(`Attempts left: ${3-attempts}`);
      if(attempts>=3){ await typeMessage(['Card blocked.','Please contact your bank.']); setTimeout(showWelcome, 1600); }
      else { setTimeout(askPIN, 800); }
    }
  }

  async function showMenu(){
    state='MENU'; keypad.innerHTML=''; setYN(false); receipt.style.display='none';
    await typeMessage(['Select a transaction']);
    setMenu(['💵 Withdraw','📊 Balance','🧾 Mini Statement','⏏ Eject Card']);
  }

  async function chooseWithdraw(){
    state='WITHDRAW_PRESET'; keypad.innerHTML=''; setYN(false);
    await typeMessage(['Please select amount','or choose CUSTOM']);
    setMenu(['LKR 1,000','LKR 2,000','LKR 5,000','LKR 10,000','CUSTOM','↩ Back']);
  }

  async function showCustomAmount(){
    state='CUSTOM'; customAmount=''; setYN(false); menu.style.display='none';
    await typeMessage(['Enter amount (LKR)']);
    setSub('Multiples of 100. Use ⌫ and OK');
    setKeypad(['1','2','3','4','5','6','7','8','9','0','⌫','OK']);
  }

  async function processing(label='Processing your transaction'){ state='PROCESSING'; keypad.innerHTML=''; menu.style.display='none'; setYN(false);
    let dots=0; const id=setInterval(()=>{dots=(dots+1)%4; setSub(label + '.'.repeat(dots));}, 350);
    await typeMessage([label,'Please wait...']);
    return ()=>clearInterval(id);
  }

  async function countingCash(){ state='COUNTING_CASH'; await typeMessage(['Counting cash']); setSub('Please wait...'); }

  async function dispense(amount){
    state='DISPENSED';
    await typeMessage([`Please collect your cash: ${fmt(amount)}`]);
    setSub('Printing receipt...');
    // Show receipt
    receipt.style.display='block';
    const now = new Date();
  receipt.innerText = [
    'Touchless Bank Receipt',
    '------------------------',
    `Date: ${now.toLocaleDateString()}  Time: ${now.toLocaleTimeString()}`,
    `Transaction: CASH WITHDRAWAL`,
    `Amount: ${fmt(amount)}`,
    `Balance: ${fmt(balance)}`,
    '------------------------',
    'Thank you for banking with us.'
  ].join('\n');
}

  async function anotherTxn(){
    await typeMessage(['Would you like another transaction?']);
    setSub('Select YES or NO');
    setYN(true);
  }

  async function showBalance(){
    state='BALANCE'; setYN(false); keypad.innerHTML=''; menu.style.display='none';
    await typeMessage([`Your current balance is:`, `${fmt(balance)}`]);
    await new Promise(r=>setTimeout(r, 700));
    anotherTxn();
  }

  async function miniStatement(){
    state='MINI'; setYN(false); keypad.innerHTML=''; menu.style.display='none';
    await typeMessage(['Fetching mini statement']); setSub('Please wait...');
    await new Promise(r=>setTimeout(r, 900));
    receipt.style.display='block';
    const now = new Date();
receipt.innerText = [
  'Touchless Bank Mini Statement',
  '------------------------------',
  `Date: ${now.toLocaleDateString()}`,
  `Balance: ${fmt(balance)}`,
  'Last 3 transactions:',
  ' - ATM CASH    LKR 2,000',
  ' - POS GROCERY LKR 1,250',
  ' - TRANSFER    LKR 5,000',
  '------------------------------'
].join('\n');
anotherTxn();
  }

  async function eject(){
    state='EXIT'; keypad.innerHTML=''; menu.style.display='none'; setYN(false);
    await typeMessage(['Please take your card','Thank you for using Touchless Bank']);
    setTimeout(showWelcome, 1300);
  }

  // Action handlers
  function onKeypad(label){
    if(state==='WELCOME' && label==='Start'){ beep(); readingCard(); return; }
    if(state==='PIN'){
      if(label==='OK'){ pinResult(pin==='1234'); return; }
      if(label==='⌫'){ pin = pin.slice(0,-1); typing.textContent = 'Enter PIN: ' + '*'.repeat(pin.length); return; }
      if(/^[0-9]$/.test(label)){ pin += label; typing.textContent = 'Enter PIN: ' + '*'.repeat(pin.length); beep(1200,40); }
      return;
    }
    if(state==='CUSTOM'){
      if(label==='OK'){
        const amt = parseInt(customAmount,10);
        if(!Number.isFinite(amt) || amt<=0 || amt%100!==0){ sub.textContent='Invalid amount. Use multiples of 100'; return; }
        doWithdraw(amt); return;
      }
      if(label==='⌫'){ customAmount = customAmount.slice(0,-1); typing.textContent = 'Enter amount: ' + (customAmount||''); return; }
      if(/^[0-9]$/.test(label)){ customAmount += label; typing.textContent = 'Enter amount: ' + customAmount; beep(1200,40); }
      return;
    }
  }

  async function doWithdraw(amount){
    const stop = await processing();
    await new Promise(r=>setTimeout(r, 900));
    stop();
    if(balance < amount){ await typeMessage(['Insufficient funds']); setSub('Select a smaller amount'); await new Promise(r=>setTimeout(r, 900)); chooseWithdraw(); return; }
    await countingCash();
    await new Promise(r=>setTimeout(r, 800));
    balance -= amount;
    await dispense(amount);
    anotherTxn();
  }

  // Start flow
  showWelcome();

  // Canvas sizing
  function fit(){ overlay.width = window.innerWidth; overlay.height = window.innerHeight; }
  window.addEventListener('resize', fit); fit();

  // Coordinate mapping — selfieMode = true, so do NOT flip X here
  function toCanvasCoords(normX, normY){
    const x = normX * overlay.width;   // no (1 - x) since landmarks already mirrored
    const y = normY * overlay.height;
    return [x, y];
  }

  // Hand tracking + dwell pointer
  function onResults(results){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    const allBtns = Array.from(document.querySelectorAll('.btn'));
    allBtns.forEach(el=>el.classList.remove('hover'));

    if(!results.multiHandLandmarks || results.multiHandLandmarks.length===0){
      dwellStart = null; hoveredBtn = null; return;
    }

    const lm = results.multiHandLandmarks[0];
    const tip = lm[8];
    const [rx, ry] = toCanvasCoords(tip.x, tip.y);

    // Smooth pointer
    if(sx==null){ sx=rx; sy=ry; }
    sx = SMOOTH*rx + (1-SMOOTH)*sx;
    sy = SMOOTH*ry + (1-SMOOTH)*sy;

    // Draw pointer dot
    ctx.beginPath(); ctx.arc(sx, sy, 10, 0, Math.PI*2); ctx.fillStyle = '#ff4d4d'; ctx.fill();

    // Hit test vs. buttons + YES/NO
    const canvasRect = overlay.getBoundingClientRect();
    const cx = sx + canvasRect.left; // convert to page coords
    const cy = sy + canvasRect.top;

    let hit = null;
    for(const el of allBtns){
      const r = el.getBoundingClientRect();
      if(cx>=r.left && cx<=r.right && cy>=r.top && cy<=r.bottom){ hit = el; break; }
    }

    if(hit){
      hit.classList.add('hover');
      if(hoveredBtn !== hit){ hoveredBtn = hit; dwellStart = performance.now(); }
      else if(performance.now() - dwellStart > DWELL_MS){
        // route click
        const txt = hit.textContent.trim();
        if(state==='MENU'){
          if(txt.includes('Withdraw')) chooseWithdraw();
          else if(txt.includes('Balance')) showBalance();
          else if(txt.includes('Mini')) miniStatement();
          else if(txt.includes('Eject')) eject();
        }
        else if(state==='WITHDRAW_PRESET'){
          if(txt==='↩ Back') showMenu();
          else if(txt==='CUSTOM') showCustomAmount();
          else {
            const amt = parseInt(txt.replace(/[^0-9]/g,''),10); doWithdraw(amt);
          }
        }
        else if(state==='WELCOME' || state==='PIN' || state==='CUSTOM'){
          onKeypad(txt);
        }
        else if(yn.style.display==='flex' && (txt==='YES' || txt==='NO')){
          setYN(false);
          if(txt==='YES') showMenu(); else eject();
        }
        dwellStart = performance.now() + 1e9; // prevent repeat
        beep(880,60);
      }
    } else { hoveredBtn = null; dwellStart = null; }
  }

  async function init(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user', width:{ideal:1280}, height:{ideal:720} }, audio:false });
      video.srcObject = stream; await video.play();
    }catch(e){ alert('Camera error: '+e.message); console.error(e); }

    const hands = new Hands({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
    hands.setOptions({ maxNumHands:1, modelComplexity:1, selfieMode:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
    hands.onResults(onResults);

    async function loop(){ await hands.send({ image: video }); requestAnimationFrame(loop); }
    loop();
  }
  init();
</script>
</body>
</html>
